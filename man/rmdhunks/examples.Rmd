
# Examples

Here is an example of the tables produced by {epitabulate} from a randomly
generated dataset. 


```{r echo = FALSE}

## define function to either print gt or tibble depending on if pkgdown or readme
## (readme doesnt allow html formatting) 
show_table <- function(tbl) {
  if (Sys.getenv("IN_PKGDOWN") == "true") {
    tbl
  } else {
    try_tbl <- try(gtsummary::as_tibble(tbl), silent = TRUE)
  if (inherits(try_tbl, "try-error")) {
    return(tbl$table_body %||% as.data.frame(tbl))
  } else {
    return(try_tbl)
  }
  }
}

```



```{r example, warning = FALSE}
library(dplyr)
library(epitabulate)

# define how many people to simulate
n <- 1000

# generate a fake dataset 
linelist <- data.frame(
  sex = sample(c("male", "female"), n, replace = TRUE),
  age_group = sample(c("<5", "5-14", "15-29", "30-44", "45-59", "60+"), n, replace = TRUE, 
                     prob = c(0.1, 0.15, 0.25, 0.2, 0.15, 0.15)),
  fever = sample(c("yes", "no"), n, replace = TRUE, prob = c(0.3, 0.7)),
  death = sample(c("yes", "no"), n, replace = TRUE, prob = c(0.05, 0.95)),
  observation_time = round(runif(n, min = 1, max = 365), 1)  # days under observation
)


# turn yes/no variables into logical (TRUE/FALSE) variables 
linelist <- linelist |> 
  mutate(
    fever = grepl("yes", fever), 
    death = grepl("yes", death)
  )

```

## Quick proportions with conficence intervals

There are three functions that will provide quick statistics for different rates
based on binomial estimates of proportions from `binom::binom.wilson()`

 - `attack_rate()`
 - `case_fatality_rate()`
 - `mortality_rate()`

```{r rates}
attack_rate(10, 50)
case_fatality_rate(2, 50)
mortality_rate(40, 50000)
```

In addition, it's possible to rapidly calculate Case fatality rate from a
linelist, stratified by different groups (e.g. gender):

```{r cfr}

case_fatality_rate_df(linelist, 
                      deaths = death, 
                      group = sex, 
                      add_total = TRUE, 
                      mergeCI = TRUE)
```

It is also possible to add these proportions on to {gtsummary} tabulations


```{r gt_cfr, warning = FALSE}
cfr <- linelist |> 
    select(death) |> 
    gtsummary::tbl_summary(
      statistic = everything() ~ "{N}",
      label = death ~ "All participants"
    ) %>%
    add_cfr(deaths_var = "death")
```

```{r gt_cfr_print, echo = FALSE}

show_table(cfr)

```


## Cross-tabulations for Odds / Risk / Incidence Rate Ratios

It is possible to add counts to {gtsummary} `tbl_uvregression`

```{r or}

## Odds ratios
or <- gtsummary::tbl_uvregression(linelist, 
                            method = glm, 
                            y = death, 
                            include = fever, 
                            method.args = list(family = binomial), 
                            exponentiate = TRUE, 
                            hide_n = TRUE) |> 
  add_crosstabs(wide = TRUE)
```

```{r or_print, echo = FALSE}

show_table(or)

```



```{r rr}
## Risk ratios 
rr <- gtsummary::tbl_uvregression(linelist, 
                            method = MASS::glm.nb, 
                            y = death,
                            include = fever, 
                            exponentiate = TRUE,
                            hide_n = TRUE) |> 
  add_crosstabs(wide = TRUE)
```

```{r rr_print, echo = FALSE}

show_table(rr)

```

```{r irr}

## Incidence rate ratios 
irr <- gtsummary::tbl_uvregression(linelist, 
                            method = glm, 
                            y = death,
                            include = fever, 
                            method.args = list(family = poisson,
                                               offset = log(observation_time)),
                            exponentiate = TRUE,
                            hide_n = TRUE) |> 
  add_crosstabs(wide = TRUE)

```

```{r irr_print, echo = FALSE}

show_table(irr)

```

## Stratification - Cochran Mantel-Haenszel estimates

It is also possible to run stratified analysis to produce Cochran Mantel-haenszel estimates. 

```{r cmh, warning = FALSE, message = FALSE}

cmh <- tbl_cmh(data = linelist,
        case = death,
        exposure = fever,
        strata = age_group, 
        measure = "OR") |>
  add_crosstabs()


```

```{r cmh_print, echo = FALSE}

show_table(cmh)

```
